<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¡°ì¹˜ì›ì ì§€ë„</title>
    <link rel="stylesheet" href="background.css" />
    <link rel="stylesheet" href="searchbar.css" />
    <link rel="stylesheet" href="category.css" />
    <link rel="stylesheet" href="map.area.css" />
    <link rel="stylesheet" href="bottomnav.css" />
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a5cc7b65ae5d251113eff578a56cd8f1"
    ></script>
  </head>
  <body>
    <div class="background">
      <!-- ìƒë‹¨ ê²€ìƒ‰ì°½ -->
      <div class="search-bar">
        <img
          src="assets/nav/search.svg"
          class="search-icon"
          width="18"
          height="18"
          alt="ê²€ìƒ‰"
        />
        <input
          class="search-input"
          type="text"
          placeholder="ê²€ìƒ‰"
          id="main-search-input"
          value="ê²€ìƒ‰"
        />
      </div>
      <!-- ì¹´í…Œê³ ë¦¬ ë°” -->
      <div class="category-bar">
        <button class="category-btn">ì „ì²´</button>
        <button class="category-btn">ë§›ì§‘</button>
        <button class="category-btn">ì¹´í˜</button>
        <button class="category-btn">ê³µì›/íœ´ì‹</button>
        <button class="category-btn">ë¬¸í™”/ê´€ê´‘</button>
      </div>
      <!-- ì§€ë„ ì˜ì—­ì€ í•­ìƒ í•˜ë‹¨ ë„¤ë¹„ ì „ê¹Œì§€ë§Œ ë³´ì„ -->
      <div class="map-area" id="mapArea">
        <div id="map" style="width: 100%; height: 100%"></div>
      </div>
      <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
      <nav class="bottom-nav">
        <a class="nav-btn" href="festival.html">
          <span class="icon-box"
            ><img src="assets/nav/festival.svg" alt="ì¶•ì œ"
          /></span>
          <span class="nav-label">ì¶•ì œ ì •ë³´</span>
        </a>
        <a class="nav-btn" href="https://www.youtube.com/sejongcity">
          <span class="icon-box"
            ><img src="assets/nav/youtube.svg" alt="ìœ íŠœë¸Œ"
          /></span>
          <span class="nav-label">ì„¸ì¢… ê³µì‹ ìœ íŠœë¸Œ</span>
        </a>
        <a class="nav-btn" href="src/index.html">
          <span class="icon-box"
            ><img src="assets/nav/trip.svg" alt="ì¶”ì²œ ì½”ìŠ¤"
          /></span>
          <span class="nav-label">ì¶”ì²œ ì½”ìŠ¤</span>
        </a>
      </nav>
    </div>

    <script>
      // URLì—ì„œ ì§€ì—­ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
      const urlParams = new URLSearchParams(window.location.search);
      const region = urlParams.get('region');

      // ì§€ì—­ë³„ ì¢Œí‘œ ì„¤ì •
      const regionCoordinates = {
        jochiwon: { lat: 36.6033, lng: 127.2983 },
        center: { lat: 36.4875, lng: 127.2817 },
        jeondong: { lat: 36.4875, lng: 127.2817 },
        yeonseo: { lat: 36.4875, lng: 127.2817 },
        yeondong: { lat: 36.4875, lng: 127.2817 },
        janggun: { lat: 36.4875, lng: 127.2817 },
        bugang: { lat: 36.4875, lng: 127.2817 },
        guemnam: { lat: 36.4875, lng: 127.2817 },
        sojeong: { lat: 36.4875, lng: 127.2817 },
        jeonui: { lat: 36.4875, lng: 127.2817 },
      };

      // ê¸°ë³¸ ì¢Œí‘œ (ì„¸ì¢…ì‹œ ì¤‘ì‹¬)
      const defaultCoords = { lat: 36.4875, lng: 127.2817 };
      const coords = regionCoordinates[region] || defaultCoords;

      // ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™”
      function initMap() {
        console.log('ğŸ—ºï¸ ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì‹œì‘...');

        const container = document.getElementById('map');
        if (!container) {
          console.error('âŒ map ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
          return;
        }

        console.log('ğŸ“ ì¢Œí‘œ:', coords);

        try {
          const options = {
            center: new kakao.maps.LatLng(coords.lat, coords.lng),
            level: 8,
          };

          const map = new kakao.maps.Map(container, options);
          console.log('âœ… ì¹´ì¹´ì˜¤ë§µ ìƒì„± ì™„ë£Œ');

          // ë§ˆì»¤ ì¶”ê°€
          const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(coords.lat, coords.lng),
          });

          marker.setMap(map);
          console.log('ğŸ“ ë§ˆì»¤ ì¶”ê°€ ì™„ë£Œ');

          // ì§€ì—­ëª… í‘œì‹œ
          if (region) {
            const regionNames = {
              jochiwon: 'ì¡°ì¹˜ì›ì',
              center: 'ì„¸ì¢…ì‹œ ì¤‘ì‹¬',
              jeondong: 'ì „ë™ë©´',
              yeonseo: 'ì—°ì„œë©´',
              yeondong: 'ì—°ë™ë©´',
              janggun: 'ì¥êµ°ë©´',
              bugang: 'ë¶€ê°•ë©´',
              guemnam: 'ê¸ˆë‚¨ë©´',
              sojeong: 'ì†Œì •ë©´',
              jeonui: 'ì „ì˜ë©´',
            };

            const regionName = regionNames[region] || region;

            // ì¸í¬ìœˆë„ìš° ì¶”ê°€
            const infowindow = new kakao.maps.InfoWindow({
              content: `<div style="padding:5px;font-size:12px;">${regionName}</div>`,
            });

            infowindow.open(map, marker);
            console.log('ğŸ·ï¸ ì¸í¬ìœˆë„ìš° ì¶”ê°€ ì™„ë£Œ:', regionName);
          }
        } catch (error) {
          console.error('âŒ ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
          // ì¹´ì¹´ì˜¤ë§µ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ì§€ë„ í‘œì‹œ
          showFallbackMap();
        }
      }

      // ëŒ€ì²´ ì§€ë„ í‘œì‹œ (API í‚¤ ì—†ìŒ)
      function showFallbackMap() {
        console.log('ğŸ—ºï¸ ëŒ€ì²´ ì§€ë„ í‘œì‹œ ì¤‘...');
        const container = document.getElementById('map');
        if (!container) return;

        const regionNames = {
          jochiwon: 'ì¡°ì¹˜ì›ì',
          center: 'ì„¸ì¢…ì‹œ ì¤‘ì‹¬',
          jeondong: 'ì „ë™ë©´',
          yeonseo: 'ì—°ì„œë©´',
          yeondong: 'ì—°ë™ë©´',
          janggun: 'ì¥êµ°ë©´',
          bugang: 'ë¶€ê°•ë©´',
          guemnam: 'ê¸ˆë‚¨ë©´',
          sojeong: 'ì†Œì •ë©´',
          jeonui: 'ì „ì˜ë©´',
        };

        const regionName = regionNames[region] || region;

        // ê°œì„ ëœ ëŒ€ì²´ ì§€ë„
        container.innerHTML = `
          <div style="width:100%; height:100%; background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); display:flex; flex-direction:column; align-items:center; justify-content:center; border-radius:18px; position:relative;">
            <div style="font-size:48px; margin-bottom:15px;">ğŸ—ºï¸</div>
            <div style="font-size:20px; font-weight:bold; margin-bottom:8px; color:#1976d2;">${regionName}</div>
            <div style="font-size:14px; color:#424242; margin-bottom:5px;">ğŸ“ ì¢Œí‘œ: ${coords.lat}, ${coords.lng}</div>
            <div style="font-size:12px; color:#757575; margin-top:10px; text-align:center;">
              ì„¸ì¢…ì‹œ ${regionName} ì§€ì—­<br>
              ì§€ë„ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
            </div>
            <div style="position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.9); padding:5px 10px; border-radius:15px; font-size:11px; color:#666;">
              ğŸ“ ì§€ë„
            </div>
          </div>
        `;
        console.log('âœ… ëŒ€ì²´ ì§€ë„ í‘œì‹œ ì™„ë£Œ');
      }

      // ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì™„ë£Œ í›„ ì§€ë„ ì´ˆê¸°í™”
      let retryCount = 0;
      const MAX_RETRIES = 5;

      function tryInitMap() {
        console.log(
          'ğŸ”„ ì¹´ì¹´ì˜¤ë§µ API í™•ì¸ ì¤‘... (ì‹œë„: ' +
            (retryCount + 1) +
            '/' +
            MAX_RETRIES +
            ')'
        );

        // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì²´í¬
        if (retryCount >= MAX_RETRIES) {
          console.log('âŒ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼, ëŒ€ì²´ ì§€ë„ í‘œì‹œ');
          showFallbackMap();
          return;
        }

        // ì¹´ì¹´ì˜¤ë§µ APIê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (typeof kakao !== 'undefined' && kakao.maps) {
          console.log('âœ… ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì™„ë£Œ, ì§€ë„ ì´ˆê¸°í™” ì‹œì‘');
          initMap();
        } else {
          console.log('â³ ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ëŒ€ê¸° ì¤‘...');
          retryCount++;
          setTimeout(tryInitMap, 1000); // 1ì´ˆ í›„ ì¬ì‹œë„
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™” ì‹œë„
      document.addEventListener('DOMContentLoaded', function () {
        console.log('ğŸ“„ DOM ë¡œë“œ ì™„ë£Œ');
        setTimeout(tryInitMap, 100);
      });

      // ì¶”ê°€ ì•ˆì „ì¥ì¹˜: window load ì´ë²¤íŠ¸
      window.addEventListener('load', function () {
        console.log('ğŸŒ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ì§€ë„ ì´ˆê¸°í™” ì¬ì‹œë„');
        setTimeout(tryInitMap, 500);
      });

      // ìµœì¢… ì•ˆì „ì¥ì¹˜: 3ì´ˆ í›„ ì¬ì‹œë„
      setTimeout(function () {
        console.log('â° ìµœì¢… ì¬ì‹œë„');
        if (typeof kakao !== 'undefined' && kakao.maps) {
          tryInitMap();
        } else {
          console.log('âŒ ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì‹¤íŒ¨, ëŒ€ì²´ ì§€ë„ í‘œì‹œ');
          showFallbackMap();
        }
      }, 3000);

      // ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
      const searchInput = document.getElementById('main-search-input');
      if (searchInput) {
        searchInput.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') handleSearch();
        });
        const searchIcon = document.querySelector('.search-icon');
        if (searchIcon) {
          searchIcon.addEventListener('click', handleSearch);
        }
      }

      function handleSearch() {
        const query = searchInput.value.trim();
        if (!query) return;

        // API URL ì„¤ì •
        const API_BASE_URL = window.location.hostname.includes('github.io')
          ? 'https://sejong-festival-api.onrender.com'
          : 'http://localhost:8000';

        fetch(`${API_BASE_URL}/api/search?q=${encodeURIComponent(query)}`)
          .then((res) => res.json())
          .then((data) => {
            if (data.type === 'region' && data.key) {
              window.location.href = `./map.html?region=${encodeURIComponent(
                data.key
              )}`;
            } else if (
              (data.type === 'cafe' || data.type === 'food') &&
              data.key
            ) {
              window.location.href = `./map-list.html?type=${encodeURIComponent(
                data.type
              )}&name=${encodeURIComponent(data.key)}`;
            } else {
              alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
          })
          .catch((err) => {
            console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', err);
            alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          });
      }

      // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í™œì„±í™”
      document.querySelectorAll('.category-btn').forEach((btn) => {
        btn.addEventListener('click', function () {
          document
            .querySelectorAll('.category-btn')
            .forEach((b) => b.classList.remove('active'));
          this.classList.add('active');
        });
      });
    </script>
  </body>
</html>
