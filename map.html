<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¡°ì¹˜ì›ì ì§€ë„</title>
    <link rel="stylesheet" href="background.css" />
    <link rel="stylesheet" href="searchbar.css" />
    <link rel="stylesheet" href="category.css" />
    <link rel="stylesheet" href="map.area.css" />
    <link rel="stylesheet" href="bottomnav.css" />
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=476ca7db55ecd66a49bc53036289f68b"
    ></script>
    <!--
    ì¹´ì¹´ì˜¤ë§µ API í‚¤ í™•ì¸ í•„ìš”:
    1. JavaScript API í‚¤ ì‚¬ìš© (REST API í‚¤ ì•„ë‹˜)
    2. ë„ë©”ì¸ ë“±ë¡: kaia-coder.github.io
    3. ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†”ì—ì„œ JavaScript í‚¤ í™•ì¸
    -->
  </head>
  <body>
    <div class="background">
      <!-- ìƒë‹¨ ë¡œê³ ë§Œ ìˆëŠ” í—¤ë” -->
      <header class="top-logo-header">
        <img src="src/assets/nav/logo.svg" alt="ì„¸ëª¨ ë¡œê³ " class="top-logo" />
        <div class="close-button" onclick="window.location.href='index.html'" style="position: absolute; top: 16px; right: 16px; z-index: 10;">
          <img src="assets/nav/close.svg" alt="ë‹«ê¸° ë²„íŠ¼" style="width: 32px; height: 32px;" />
        </div>
      </header>

      <!-- ì¹´í…Œê³ ë¦¬ ë°” -->
      <div class="category-bar">
        <button class="category-btn">ì „ì²´</button>
        <button class="category-btn">ë§›ì§‘</button>
        <button class="category-btn">ì¹´í˜</button>
        <button class="category-btn">ê³µì›/íœ´ì‹</button>
        <button class="category-btn">ë¬¸í™”/ê´€ê´‘</button>
      </div>
      <!-- ì§€ë„ ì˜ì—­ì€ í•­ìƒ í•˜ë‹¨ ë„¤ë¹„ ì „ê¹Œì§€ë§Œ ë³´ì„ -->
      <div class="map-area" id="mapArea">
        <div id="map" style="width: 100%; height: 100%"></div>
      </div>
      <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
      <nav class="bottom-nav">
        <a class="nav-btn" href="festival.html">
          <span class="icon-box"
            ><img src="assets/nav/festival.svg" alt="ì¶•ì œ"
          /></span>
          <span class="nav-label">ì¶•ì œ ì •ë³´</span>
        </a>
        <a class="nav-btn" href="https://www.youtube.com/sejongcity">
          <span class="icon-box"
            ><img src="assets/nav/youtube.svg" alt="ìœ íŠœë¸Œ"
          /></span>
          <span class="nav-label">ì„¸ì¢… ê³µì‹ ìœ íŠœë¸Œ</span>
        </a>
        <a class="nav-btn" href="src/index.html">
          <span class="icon-box"
            ><img src="assets/nav/trip.svg" alt="ì¶”ì²œ ì½”ìŠ¤"
          /></span>
          <span class="nav-label">ì¶”ì²œ ì½”ìŠ¤</span>
        </a>
      </nav>
    </div>

    <script>
      // 1. ì „ì—­ ë³€ìˆ˜ ì¶”ê°€ - ìµœìƒë‹¨ì— ë°°ì¹˜
      let map;
      let mainMarker = null;
      let mainInfowindow = null;

      // URLì—ì„œ ì§€ì—­ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
      const urlParams = new URLSearchParams(window.location.search);
      const region = urlParams.get('region');

      // ì§€ì—­ë³„ ì¢Œí‘œ ì„¤ì •
      const regionCoordinates = {
        jochiwon: { lat: 36.6033, lng: 127.2983 },
        center: { lat: 36.4875, lng: 127.2817 },
        jeondong: { lat: 36.4875, lng: 127.2817 },
        yeonseo: { lat: 36.4875, lng: 127.2817 },
        yeondong: { lat: 36.4875, lng: 127.2817 },
        janggun: { lat: 36.4875, lng: 127.2817 },
        bugang: { lat: 36.4875, lng: 127.2817 },
        guemnam: { lat: 36.4875, lng: 127.2817 },
        sojeong: { lat: 36.4875, lng: 127.2817 },
        jeonui: { lat: 36.4875, lng: 127.2817 },
      };

      // ê¸°ë³¸ ì¢Œí‘œ (ì„¸ì¢…ì‹œ ì¤‘ì‹¬)
      const defaultCoords = { lat: 36.4875, lng: 127.2817 };
      const coords = regionCoordinates[region] || defaultCoords;

      // 2. ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™”
      function initMap() {
        console.log('ğŸ—ºï¸ ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì‹œì‘...');

        const container = document.getElementById('map');
        if (!container) {
          console.error('âŒ map ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
          return;
        }

        console.log('ğŸ“ ì¢Œí‘œ:', coords);

        try {
          const options = {
            center: new kakao.maps.LatLng(coords.lat, coords.lng),
            level: 8,
          };

          map = new kakao.maps.Map(container, options);
          console.log('âœ… ì¹´ì¹´ì˜¤ë§µ ìƒì„± ì™„ë£Œ');

          // ê¸°ì¡´ ì§€ì—­ ë§ˆì»¤Â·ì¸í¬ìœˆë„ìš° ìƒì„± ë° ì „ì—­ ë³€ìˆ˜ í• ë‹¹
          mainMarker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(coords.lat, coords.lng),
          });
          mainMarker.setMap(map);

          if (region) {
            const regionNames = {
              jochiwon: 'ì¡°ì¹˜ì›ì',
              center: 'ì„¸ì¢…ì‹œ ì¤‘ì‹¬',
              jeondong: 'ì „ë™ë©´',
              yeonseo: 'ì—°ì„œë©´',
              yeondong: 'ì—°ë™ë©´',
              janggun: 'ì¥êµ°ë©´',
              bugang: 'ë¶€ê°•ë©´',
              guemnam: 'ê¸ˆë‚¨ë©´',
              sojeong: 'ì†Œì •ë©´',
              jeonui: 'ì „ì˜ë©´',
            };
            const regionName = regionNames[region] || region;

            mainInfowindow = new kakao.maps.InfoWindow({
              content: `<div style="padding:5px;font-size:12px;">${regionName}</div>`,
            });
            mainInfowindow.open(map, mainMarker);

            console.log('ğŸ·ï¸ ì¸í¬ìœˆë„ìš° ì¶”ê°€ ì™„ë£Œ:', regionName);
          }
        } catch (error) {
          console.error('âŒ ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
          showFallbackMap();
        }
      }

      // ëŒ€ì²´ ì§€ë„ í‘œì‹œ (API í‚¤ ì—†ìŒ)
      function showFallbackMap() {
        console.log('ğŸ—ºï¸ ëŒ€ì²´ ì§€ë„ í‘œì‹œ ì¤‘...');
        const container = document.getElementById('map');
        if (!container) return;

        const regionNames = {
          jochiwon: 'ì¡°ì¹˜ì›ì',
          center: 'ì„¸ì¢…ì‹œ ì¤‘ì‹¬',
          jeondong: 'ì „ë™ë©´',
          yeonseo: 'ì—°ì„œë©´',
          yeondong: 'ì—°ë™ë©´',
          janggun: 'ì¥êµ°ë©´',
          bugang: 'ë¶€ê°•ë©´',
          guemnam: 'ê¸ˆë‚¨ë©´',
          sojeong: 'ì†Œì •ë©´',
          jeonui: 'ì „ì˜ë©´',
        };

        const regionName = regionNames[region] || region;

        container.innerHTML = `
          <div style="width:100%; height:100%; background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); display:flex; flex-direction:column; align-items:center; justify-content:center; border-radius:18px; position:relative;">
            <div style="font-size:48px; margin-bottom:15px;">ğŸ—ºï¸</div>
            <div style="font-size:20px; font-weight:bold; margin-bottom:8px; color:#1976d2;">${regionName}</div>
            <div style="font-size:14px; color:#424242; margin-bottom:5px;">ğŸ“ ì¢Œí‘œ: ${coords.lat}, ${coords.lng}</div>
            <div style="font-size:12px; color:#757575; margin-top:10px; text-align:center;">
              ì„¸ì¢…ì‹œ ${regionName} ì§€ì—­<br>
              ì§€ë„ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
            </div>
            <div style="position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.9); padding:5px 10px; border-radius:15px; font-size:11px; color:#666;">
              ğŸ“ ì§€ë„
            </div>
          </div>
        `;
        console.log('âœ… ëŒ€ì²´ ì§€ë„ í‘œì‹œ ì™„ë£Œ');
      }

      // 3. ì¡°ì¹˜ì›ì§¬ë½• ë§›ì§‘ ë§ˆì»¤ í‘œì‹œ í•¨ìˆ˜
      function showRestaurantMarker() {
        // ê¸°ì¡´ ì§€ì—­ ë§ˆì»¤ì™€ ì¸í¬ìœˆë„ìš° ì œê±°
        if (mainInfowindow) {
          mainInfowindow.close();
        }
        if (mainMarker) {
          mainMarker.setMap(null);
        }

        // ì¡°ì¹˜ì›ì§¬ë½• ìœ„ì¹˜ ì¢Œí‘œ
        const rLat = 36.6016860496612;
        const rLng = 127.291591378015;

        mainMarker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(rLat, rLng),
        });
        mainMarker.setMap(map);

        const infoHtml = `
          <div style="min-width:160px;padding:6px 10px;font-size:12px;">
            <b>ì¡°ì¹˜ì›ì§¬ë½•</b><br>
            ì„¸ì¢… ì¡°ì¹˜ì›ì ëŒë§ˆë£¨2ê¸¸ 7
          </div>
        `;
        mainInfowindow = new kakao.maps.InfoWindow({ content: infoHtml });
        mainInfowindow.open(map, mainMarker);

        map.setCenter(new kakao.maps.LatLng(rLat, rLng));
      }

      // 4. ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ í™•ì¥ (ê¸°ì¡´ + ë§›ì§‘ ê¸°ëŠ¥)
      document.querySelectorAll('.category-btn').forEach((btn) => {
        btn.addEventListener('click', function () {
          // ë²„íŠ¼ í™œì„±í™” í† ê¸€
          document.querySelectorAll('.category-btn').forEach((b) => b.classList.remove('active'));
          this.classList.add('active');

          if (this.textContent.trim() === 'ë§›ì§‘') {
            showRestaurantMarker();
          } else {
            // ë§›ì§‘ ì´ì™¸, ê¸°ì¡´ ì§€ì—­ë§ˆì»¤ë¡œ ë³µì›
            if (mainInfowindow) {
              mainInfowindow.close();
            }
            if (mainMarker) {
              mainMarker.setMap(null);
            }

            mainMarker = new kakao.maps.Marker({
              position: new kakao.maps.LatLng(coords.lat, coords.lng),
            });
            mainMarker.setMap(map);

            if (region) {
              const regionNames = {
                jochiwon: 'ì¡°ì¹˜ì›ì',
                center: 'ì„¸ì¢…ì‹œ ì¤‘ì‹¬',
                jeondong: 'ì „ë™ë©´',
                yeonseo: 'ì—°ì„œë©´',
                yeondong: 'ì—°ë™ë©´',
                janggun: 'ì¥êµ°ë©´',
                bugang: 'ë¶€ê°•ë©´',
                guemnam: 'ê¸ˆë‚¨ë©´',
                sojeong: 'ì†Œì •ë©´',
                jeonui: 'ì „ì˜ë©´',
              };
              const regionName = regionNames[region] || region;

              mainInfowindow = new kakao.maps.InfoWindow({
                content: `<div style="padding:5px;font-size:12px;">${regionName}</div>`,
              });
              mainInfowindow.open(map, mainMarker);
            }
            map.setCenter(new kakao.maps.LatLng(coords.lat, coords.lng));
          }
        });
      });

      // ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì™„ë£Œ í›„ ì§€ë„ ì´ˆê¸°í™” ì‹œë„
      let retryCount = 0;
      const MAX_RETRIES = 5;

      function tryInitMap() {
        console.log(
          'ğŸ”„ ì¹´ì¹´ì˜¤ë§µ API í™•ì¸ ì¤‘... (ì‹œë„: ' +
            (retryCount + 1) +
            '/' +
            MAX_RETRIES +
            ')'
        );

        if (retryCount >= MAX_RETRIES) {
          console.log('âŒ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼, ëŒ€ì²´ ì§€ë„ í‘œì‹œ');
          showFallbackMap();
          return;
        }

        if (typeof kakao !== 'undefined' && kakao.maps) {
          console.log('âœ… ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì™„ë£Œ, ì§€ë„ ì´ˆê¸°í™” ì‹œì‘');
          initMap();
        } else {
          console.log('â³ ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ëŒ€ê¸° ì¤‘...');
          retryCount++;
          setTimeout(tryInitMap, 1000);
        }
      }

      document.addEventListener('DOMContentLoaded', function () {
        console.log('ğŸ“„ DOM ë¡œë“œ ì™„ë£Œ');
        setTimeout(tryInitMap, 100);
      });

      window.addEventListener('load', function () {
        console.log('ğŸŒ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ì§€ë„ ì´ˆê¸°í™” ì¬ì‹œë„');
        setTimeout(tryInitMap, 500);
      });

      setTimeout(function () {
        console.log('â° ìµœì¢… ì¬ì‹œë„');
        if (typeof kakao !== 'undefined' && kakao.maps) {
          tryInitMap();
        } else {
          console.log('âŒ ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì‹¤íŒ¨, ëŒ€ì²´ ì§€ë„ í‘œì‹œ');
          showFallbackMap();
        }
      }, 3000);


      // ê²€ìƒ‰ ê¸°ëŠ¥ ë° ê¸°íƒ€ ê¸°ì¡´ ì½”ë“œ ê³„ì† ìœ ì§€...
      const searchInput = document.getElementById('main-search-input');
      if (searchInput) {
        searchInput.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') handleSearch();
        });
        const searchIcon = document.querySelector('.search-icon');
        if (searchIcon) {
          searchIcon.addEventListener('click', handleSearch);
        }
      }

      function handleSearch() {
        const query = searchInput.value.trim();
        if (!query) return;

        const API_BASE_URL = window.location.hostname.includes('github.io')
          ? 'https://sejong-festival-api.onrender.com'
          : 'http://localhost:8000';

        fetch(`${API_BASE_URL}/api/search?q=${encodeURIComponent(query)}`)
          .then((res) => res.json())
          .then((data) => {
            if (data.type === 'region' && data.key) {
              window.location.href = `./map.html?region=${encodeURIComponent(data.key)}`;
            } else if (
              (data.type === 'cafe' || data.type === 'food') &&
              data.key
            ) {
              window.location.href = `./map-list.html?type=${encodeURIComponent(
                data.type
              )}&name=${encodeURIComponent(data.key)}`;
            } else {
              alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
          })
          .catch((err) => {
            console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', err);
            alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          });
      }
    </script>
  </body>
</html>
