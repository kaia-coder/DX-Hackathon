<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>조치원읍 지도</title>
    <link rel="stylesheet" href="background.css" />
    <link rel="stylesheet" href="searchbar.css" />
    <link rel="stylesheet" href="category.css" />
    <link rel="stylesheet" href="map.area.css" />
    <link rel="stylesheet" href="bottomnav.css" />
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=476ca7db55ecd66a49bc53036289f68b"
    ></script>
    <!--
    카카오맵 API 키 확인 필요
    -->
  </head>
  <body>
    <div class="background">
      <!-- 상단 로고만 있는 헤더 -->
      <header class="top-logo-header">
        <img src="src/assets/nav/logo.svg" alt="세모 로고" class="top-logo" />
        <div class="close-button" onclick="window.location.href='index.html'" style="position: absolute; top: 16px; right: 16px; z-index: 10;">
          <img src="assets/nav/close.svg" alt="닫기 버튼" style="width: 32px; height: 32px;" />
        </div>
      </header>

      <!-- 카테고리 바 -->
      <div class="category-bar">
        <button class="category-btn">지역</button>
        <button class="category-btn">맛집</button>
        <button class="category-btn">카페</button>
        <button class="category-btn">공원/휴식</button>
        <button class="category-btn">문화/관광</button>
      </div>
      <!-- 지도 영역 -->
      <div class="map-area" id="mapArea">
        <div id="map" style="width: 100%; height: 100%"></div>
      </div>
      <!-- 하단 네비게이션 -->
      <nav class="bottom-nav">
        <a class="nav-btn" href="festival.html">
          <span class="icon-box"><img src="assets/nav/festival.svg" alt="축제" /></span>
          <span class="nav-label">축제 정보</span>
        </a>
        <a class="nav-btn" href="https://www.youtube.com/sejongcity">
          <span class="icon-box"><img src="assets/nav/youtube.svg" alt="유튜브" /></span>
          <span class="nav-label">세종 공식 유튜브</span>
        </a>
        <a class="nav-btn" href="src/index.html">
          <span class="icon-box"><img src="assets/nav/trip.svg" alt="추천 코스" /></span>
          <span class="nav-label">추천 코스</span>
        </a>
      </nav>
    </div>

    <script>
      // 1. 전역 변수 선언 (여러 마커/인포윈도우 관리를 위해 배열 사용)
      let map;
      let mainMarkers = [];
      let mainInfowindows = [];
      let defaultMarker = null;      // 지역 기본 마커
      let defaultInfowindow = null;  // 지역명

      // URL에서 지역 파라미터 가져오기
      const urlParams = new URLSearchParams(window.location.search);
      const region = urlParams.get('region');

      // 지역별 좌표 설정
      const regionCoordinates = {
        jochiwon: { lat: 36.6033, lng: 127.2983 },
        center: { lat: 36.4875, lng: 127.2817 },
        jeondong: { lat: 36.4875, lng: 127.2817 },
        yeonseo: { lat: 36.4875, lng: 127.2817 },
        yeondong: { lat: 36.4875, lng: 127.2817 },
        janggun: { lat: 36.4875, lng: 127.2817 },
        bugang: { lat: 36.4875, lng: 127.2817 },
        guemnam: { lat: 36.4875, lng: 127.2817 },
        sojeong: { lat: 36.4875, lng: 127.2817 },
        jeonui: { lat: 36.4875, lng: 127.2817 },
      };

      // 기본 좌표 (세종시 중심)
      const defaultCoords = { lat: 36.4875, lng: 127.2817 };
      const coords = regionCoordinates[region] || defaultCoords;

      // [카테고리별 장소정보 데이터]
      const RESTAURANT_LIST = [
        {
          name: '조치원짬뽕',
          address: '세종 조치원읍 돌마루2길 7',
          lat: 36.6016860496612,
          lng: 127.291591378015,
        },
        {
          name: '돈스',
          address: '세종특별자치시 조치원읍 서창리 291-10',
          lat: 36.594627277063,
          lng: 127.295373236779,
        }
      ];
      const CAFE_LIST = [
        {
          name: '브레드마마',
          address: '세종특별자치시 조치원읍 서창리 297-5',
          lat: 36.594276083682, lng: 127.294993759002,
        },
        {
          name: 'Modest impact',
          address: '세종특별자치시 조치원읍 원리 141-47',
          lat: 36.600406148246, lng: 127.294482825705,
        }
      ];
      const PARK_LIST = [
        {
          name: '침산공원',
          address: '세종특별자치시 조치원읍 침산리 179-3',
          lat: 36.600445314001, lng: 127.313799289308,
        },
        {
          name: '조천연꽃공원',
          address: '세종특별자치시 조치원읍 번암리 226',
          lat: 36.582462776471, lng: 127.304216407588,
        }
      ];
      const CULTURE_LIST = [
        {
          name: '세종문화예술회관',
          address: '세종특별자치시 조치원읍 침산리 226-1',
          lat: 36.5988057603944, lng: 127.315779111905,
        },
        {
          name: '조치원 1927 아트센터',
          address: '세종특별자치시 조치원읍 남리 60-1',
          lat: 36.5962881166436, lng: 127.294720570861,
        }
      ];

      // 2. 지도 초기화 (지역 기본 마커 표시)
      function initMap() {
        const container = document.getElementById('map');
        if (!container) return;

        const options = {
          center: new kakao.maps.LatLng(coords.lat, coords.lng),
          level: 8,
        };
        map = new kakao.maps.Map(container, options);

        // 기본 지역 마커/윈도우 세팅
        defaultMarker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(coords.lat, coords.lng),
        });
        defaultMarker.setMap(map);

        if (region) {
          const regionNames = {
            jochiwon: '조치원읍',
            center: '세종시 중심',
            jeondong: '전동면',
            yeonseo: '연서면',
            yeondong: '연동면',
            janggun: '장군면',
            bugang: '부강면',
            guemnam: '금남면',
            sojeong: '소정면',
            jeonui: '전의면',
          };
          const regionName = regionNames[region] || region;
          defaultInfowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;font-size:12px;">${regionName}</div>`,
          });
          defaultInfowindow.open(map, defaultMarker);
        }
      }

      // 3. 카테고리별 마커 표시 함수
      function showCategoryMarkers(list) {
        // 기존 마커/인포윈도우 모두 제거
        mainInfowindows.forEach(infowindow => infowindow.close());
        mainMarkers.forEach(marker => marker.setMap(null));
        mainMarkers = [];
        mainInfowindows = [];

        // 기본 지역 마커/윈도우 숨기기
        if (defaultInfowindow) defaultInfowindow.close();
        if (defaultMarker) defaultMarker.setMap(null);

        list.forEach(({ name, address, lat, lng }) => {
          const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(lat, lng),
          });
          marker.setMap(map);
          mainMarkers.push(marker);

          const infoHtml = `
            <div style="min-width:160px;padding:6px 10px;font-size:12px;">
              <b>${name}</b><br>
              ${address}
            </div>
          `;
          const infowindow = new kakao.maps.InfoWindow({ content: infoHtml });
          infowindow.open(map, marker);
          mainInfowindows.push(infowindow);
        });

        if (list.length > 0) {
          map.setCenter(new kakao.maps.LatLng(list[0].lat, list[0].lng));
        }
      }

      // 4. 모든 마커 제거 후 지역 기본 마커만 복원
      function restoreDefaultMarker() {
        mainInfowindows.forEach(infowindow => infowindow.close());
        mainMarkers.forEach(marker => marker.setMap(null));
        mainMarkers = [];
        mainInfowindows = [];

        // 지역 마커/윈도우 복귀
        defaultMarker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(coords.lat, coords.lng),
        });
        defaultMarker.setMap(map);

        if (region) {
          const regionNames = {
            jochiwon: '조치원읍', center: '세종시 중심',
            jeondong: '전동면', yeonseo: '연서면', yeondong: '연동면',
            janggun: '장군면', bugang: '부강면', guemnam: '금남면',
            sojeong: '소정면', jeonui: '전의면',
          };
          const regionName = regionNames[region] || region;
          defaultInfowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;font-size:12px;">${regionName}</div>`,
          });
          defaultInfowindow.open(map, defaultMarker);
        }
        map.setCenter(new kakao.maps.LatLng(coords.lat, coords.lng));
      }

      // 5. 카테고리 버튼 클릭 이벤트
      document.querySelectorAll('.category-btn').forEach((btn) => {
        btn.addEventListener('click', function () {
          document.querySelectorAll('.category-btn').forEach((b) => b.classList.remove('active'));
          this.classList.add('active');

          const category = this.textContent.trim();

          if (category === '맛집') {
            showCategoryMarkers(RESTAURANT_LIST);
          } else if (category === '카페') {
            showCategoryMarkers(CAFE_LIST);
          } else if (category === '공원/휴식') {
            showCategoryMarkers(PARK_LIST);
          } else if (category === '문화/관광') {
            showCategoryMarkers(CULTURE_LIST);
          } else {
            restoreDefaultMarker();
          }
        });
      });

      // 카카오맵 API 로드 후 지도 초기화
      let retryCount = 0;
      const MAX_RETRIES = 5;
      function tryInitMap() {
        if (retryCount >= MAX_RETRIES) return;
        if (typeof kakao !== 'undefined' && kakao.maps) {
          initMap();
        } else {
          retryCount++;
          setTimeout(tryInitMap, 500);
        }
      }
      document.addEventListener('DOMContentLoaded', () => setTimeout(tryInitMap, 100));
      window.addEventListener('load', () => setTimeout(tryInitMap, 500));
      setTimeout(tryInitMap, 2000);

    </script>
  </body>
</html>
